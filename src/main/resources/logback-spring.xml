<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- ===== í”„ë¡œíŒŒì¼ë³„ ë¡œê·¸ ê²½ë¡œ ì„¤ì • ===== -->
    <springProfile name="local,default,dev">
        <property name="LOG_PATH" value="./logs/ads-service"/>
    </springProfile>

    <springProfile name="prod">
        <!-- ìš´ì˜ í™˜ê²½: Promtailì´ ìˆ˜ì§‘í•  ê²½ë¡œ -->
        <property name="LOG_PATH" value="/var/log/reciping/ads-service"/>
    </springProfile>

    <property name="LOG_FILE" value="ads-service-app"/>

    <!-- ===== ì½˜ì†” ì¶œë ¥ (ë¡œì»¬ ê°œë°œìš©) ===== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- ===== ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ===== -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>14</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>

        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n</pattern>
            <immediateFlush>true</immediateFlush>
        </encoder>
    </appender>

    <!-- ===== AdController ì „ìš© ë¡œê·¸ - ìµœì í™”ëœ JSON ===== -->
    <appender name="AD_CONTROLLER_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/AdController.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/AdController.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>

        <!-- ðŸ”§ ìˆ˜ì •: LoggingEventCompositeJsonEncoder ì‚¬ìš©ìœ¼ë¡œ ë” ì„¸ë°€í•œ ì œì–´ -->
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>Asia/Seoul</timeZone>
                    <pattern>yyyy-MM-dd'T'HH:mm:ss.SSS</pattern>
                </timestamp>
                <version/>
                <logLevel/>
                <message/>
                <!-- ðŸ”§ MDC í•„í„°ë§: í•µì‹¬ ë¼ë²¨ë§Œ í¬í•¨ -->
                <mdc>
                    <includeMdcKeyName>traceId</includeMdcKeyName>
                    <includeMdcKeyName>logType</includeMdcKeyName>
                    <includeMdcKeyName>actorType</includeMdcKeyName>
                    <includeMdcKeyName>userId</includeMdcKeyName>
                    <includeMdcKeyName>targetId</includeMdcKeyName>
                    <includeMdcKeyName>adPosition</includeMdcKeyName>
                    <includeMdcKeyName>userSegment</includeMdcKeyName>
                    <includeMdcKeyName>scenario</includeMdcKeyName>
                </mdc>
                <!-- ðŸ”§ StructuredArguments í¬í•¨ (í•µì‹¬!) -->
                <arguments>
                    <includeNonStructuredArguments>false</includeNonStructuredArguments>
                </arguments>
                <loggerName>
                    <shortenedLoggerNameLength>36</shortenedLoggerNameLength>
                </loggerName>
                <!-- ðŸ”§ ê³ ì • í•„ë“œ ì¶”ê°€ -->
                <pattern>
                    <pattern>
                        {
                        "service": "ads-service",
                        "phase": "PHASE_1",
                        "logger": "AdController",
                        "environment": "${spring.profiles.active:-dev}"
                        }
                    </pattern>
                </pattern>
            </providers>
            <!-- ðŸ”§ ì„±ëŠ¥ ìµœì í™” ì„¤ì • -->
            <includeContext>false</includeContext>
            <!-- ðŸ”§ JSON ì••ì¶• ì„¤ì • -->
            <jsonGeneratorDecorator class="net.logstash.logback.decorate.CompositeJsonGeneratorDecorator">
                <decorator class="net.logstash.logback.decorate.PrettyPrintingJsonGeneratorDecorator">
                    <prettyPrint>false</prettyPrint>
                </decorator>
            </jsonGeneratorDecorator>
        </encoder>
    </appender>

    <!-- ===== ê´‘ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë²¤íŠ¸ ë¡œê·¸ (ë¶„ì„ìš©) ===== -->
    <appender name="AD_BUSINESS_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/ad-business-events.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/ad-business-events.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>90</maxHistory>
            <totalSizeCap>50GB</totalSizeCap>
        </rollingPolicy>

        <!-- ðŸ”§ ìˆ˜ì •: ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë²¤íŠ¸ íŠ¹í™” ì„¤ì • -->
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>Asia/Seoul</timeZone>
                </timestamp>
                <logLevel/>
                <message/>
                <!-- ðŸ”§ Phase 1 ë¶„ì„ìš© MDC í•„í„°ë§ -->
                <mdc>
                    <includeMdcKeyName>traceId</includeMdcKeyName>
                    <includeMdcKeyName>logType</includeMdcKeyName>
                    <includeMdcKeyName>actorType</includeMdcKeyName>
                    <includeMdcKeyName>userId</includeMdcKeyName>
                    <includeMdcKeyName>adPosition</includeMdcKeyName>
                    <includeMdcKeyName>userSegment</includeMdcKeyName>
                    <includeMdcKeyName>scenario</includeMdcKeyName>
                </mdc>
                <!-- ðŸ”§ Phase 1 ë©”íŠ¸ë¦­ ë°ì´í„° í¬í•¨ -->
                <arguments>
                    <includeNonStructuredArguments>false</includeNonStructuredArguments>
                </arguments>
                <!-- ðŸ”§ ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¹í™” í•„ë“œ -->
                <pattern>
                    <pattern>
                        {
                        "service": "ads-service",
                        "log_type": "business_events",
                        "phase": "PHASE_1",
                        "environment": "${spring.profiles.active:-unknown}"
                        }
                    </pattern>
                </pattern>
            </providers>
            <includeContext>false</includeContext>
        </encoder>
    </appender>

    <!-- ===== AdSelector ì „ìš© ë¡œê·¸ (ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ê°€ë³ê²Œ) ===== -->
    <appender name="AD_SELECTOR_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/AdSelector.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/AdSelector.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>14</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>

        <!-- ê°€ë²¼ìš´ í…ìŠ¤íŠ¸ ë¡œê·¸ (ë³€ê²½ ì—†ìŒ) -->
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}] %logger{36} - %msg%n</pattern>
            <immediateFlush>true</immediateFlush>
        </encoder>
    </appender>

    <!-- ===== ê´‘ê³  ë©”íŠ¸ë¦­ ë¡œê·¸ (ì‹œê°„ë³„ ë¡¤ë§) ===== -->
    <appender name="AD_METRICS_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/ad-metrics.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/ad-metrics.%d{yyyy-MM-dd_HH}.log</fileNamePattern>
            <maxHistory>168</maxHistory> <!-- 7ì¼ * 24ì‹œê°„ -->
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>

        <!-- ðŸ”§ ìˆ˜ì •: ë©”íŠ¸ë¦­ íŠ¹í™” JSON ì„¤ì • -->
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <timeZone>Asia/Seoul</timeZone>
            <includeContext>false</includeContext>
            <includeMdc>true</includeMdc>
            <includeStructuredArguments>true</includeStructuredArguments>
            <customFields>{"service":"ads-service","log_type":"metrics"}</customFields>
        </encoder>
    </appender>

    <!-- ===== ë¹„ë™ê¸° ë¡œê¹… ì„¤ì • (ì„±ëŠ¥ ìµœì í™”) ===== -->

    <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œê·¸ìš© ë¹„ë™ê¸° ì²˜ë¦¬ -->
    <appender name="ASYNC_AD_BUSINESS" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="AD_BUSINESS_LOG"/>
        <!-- ðŸ”§ ìµœì í™”: í í¬ê¸° ì¦ê°€ (ë†’ì€ ì²˜ë¦¬ëŸ‰ ëŒ€ì‘) -->
        <queueSize>2048</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
        <maxFlushTime>3000</maxFlushTime>             <!-- ðŸ”§ 3ì´ˆë¡œ ë‹¨ì¶• -->
    </appender>

    <!-- ë©”íŠ¸ë¦­ ë¡œê·¸ìš© ë¹„ë™ê¸° ì²˜ë¦¬ -->
    <appender name="ASYNC_AD_METRICS" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="AD_METRICS_LOG"/>
        <queueSize>1024</queueSize>                   <!-- ðŸ”§ í¬ê¸° ì¦ê°€ -->
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
        <maxFlushTime>3000</maxFlushTime>
    </appender>

    <!-- ===== í”„ë¡œíŒŒì¼ë³„ ë£¨íŠ¸ ë¡œê±° ì„¤ì • ===== -->

    <!-- ë¡œì»¬ ê°œë°œ: ì½˜ì†” + íŒŒì¼ -->
    <springProfile name="local,default">
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
            <appender-ref ref="FILE" />
        </root>
    </springProfile>

    <!-- ìš´ì˜/ê°œë°œ: íŒŒì¼ë§Œ (ì„±ëŠ¥ ìµœì í™”) -->
    <springProfile name="dev,prod">
        <root level="INFO">
            <appender-ref ref="FILE" />
        </root>
    </springProfile>

    <!-- ===== í´ëž˜ìŠ¤ë³„ íŠ¹í™” ë¡œê±° ì„¤ì • ===== -->

    <!-- AdController: JSON + ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë²¤íŠ¸ (ë¹„ë™ê¸°) -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.ad.controller.AdController"
            additivity="false">
        <appender-ref ref="AD_CONTROLLER_LOG" />
        <appender-ref ref="ASYNC_AD_BUSINESS" />
    </logger>

    <!-- AdSelector: ê°€ë²¼ìš´ í…ìŠ¤íŠ¸ ë¡œê·¸ -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.ad.service.selector.AdSelector"
            additivity="false">
        <appender-ref ref="AD_SELECTOR_LOG" />
    </logger>

    <!-- ê´‘ê³  ë©”íŠ¸ë¦­ ì „ìš© ë¡œê±° (ë¹„ë™ê¸°) -->
    <logger level="INFO"
            name="AdMetricsLogger"
            additivity="false">
        <appender-ref ref="ASYNC_AD_METRICS" />
    </logger>

    <!-- ðŸ”§ ì¶”ê°€: AdLogger ì „ìš© ì„¤ì • (í•„ìš”ì‹œ) -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.log.logger.AdLogger"
            additivity="false">
        <appender-ref ref="ASYNC_AD_BUSINESS" />
    </logger>

    <!-- ===== ê°œë°œ í™˜ê²½ ë””ë²„ê¹… ì„¤ì • ===== -->
    <springProfile name="local">
        <!-- ë¡œì»¬ì—ì„œë§Œ DEBUG ë ˆë²¨ í™œì„±í™” -->
        <logger name="com.three.recipingadsservicebe.ad" level="DEBUG"/>
        <logger name="com.three.recipingadsservicebe.segment" level="DEBUG"/>
        <logger name="com.three.recipingadsservicebe.log" level="DEBUG"/>
    </springProfile>

    <!-- ===== íŠ¹ì • ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œê·¸ ë ˆë²¨ ì¡°ì • ===== -->
    <logger name="org.springframework.security" level="WARN"/>
    <logger name="org.apache.http" level="WARN"/>
    <logger name="com.fasterxml.jackson" level="WARN"/>
    <!-- ðŸ”§ ì¶”ê°€: logstash ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œê·¸ ë ˆë²¨ ì¡°ì • -->
    <logger name="net.logstash.logback" level="WARN"/>

</configuration>