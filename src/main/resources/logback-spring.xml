<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- ===== JSON 콘솔 출력 (운영 환경용) ===== -->
    <appender name="JSON_STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- 타임존 설정 -->
            <timeZone>Asia/Seoul</timeZone>
            <!-- 커스텀 필드 추가 -->
            <customFields>{"service":"ads-service","environment":"${spring.profiles.active:-dev}"}</customFields>
            <!-- MDC 키 포함 -->
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>logType</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>userSegment</includeMdcKeyName>
            <includeMdcKeyName>scenario</includeMdcKeyName>
            <includeMdcKeyName>abGroup</includeMdcKeyName>
            <includeMdcKeyName>servingSuccess</includeMdcKeyName>
            <includeMdcKeyName>actorType</includeMdcKeyName>
            <includeMdcKeyName>targetId</includeMdcKeyName>
            <includeMdcKeyName>adPosition</includeMdcKeyName>
        </encoder>
    </appender>

    <!-- ===== 일반 텍스트 콘솔 출력 (로컬 개발용) ===== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- ===== 프로파일별 루트 로거 설정 ===== -->

    <!-- 로컬 개발 환경: 일반 텍스트 콘솔 -->
    <springProfile name="local,default">
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
        </root>
    </springProfile>

    <!-- 개발/운영 환경: JSON 콘솔 -->
    <springProfile name="dev,prod,test">
        <root level="INFO">
            <appender-ref ref="JSON_STDOUT" />
        </root>
    </springProfile>

    <!-- ===== 광고 도메인 특화 로거 설정 ===== -->

    <!-- 광고 서빙 컨트롤러 -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.ad.controller.AdServingController"
            additivity="false">
        <springProfile name="local,default">
            <appender-ref ref="CONSOLE" />
        </springProfile>
        <springProfile name="dev,prod,test">
            <appender-ref ref="JSON_STDOUT" />
        </springProfile>
    </logger>

    <!-- 광고 관리 컨트롤러 -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.ad.controller.AdManagementController"
            additivity="false">
        <springProfile name="local,default">
            <appender-ref ref="CONSOLE" />
        </springProfile>
        <springProfile name="dev,prod,test">
            <appender-ref ref="JSON_STDOUT" />
        </springProfile>
    </logger>

    <!-- 광고 추천 서비스 -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.ad.service.AdRecommendationService"
            additivity="false">
        <springProfile name="local,default">
            <appender-ref ref="CONSOLE" />
        </springProfile>
        <springProfile name="dev,prod,test">
            <appender-ref ref="JSON_STDOUT" />
        </springProfile>
    </logger>

    <!-- AdLogger (광고 도메인 전용 로거) -->
    <logger level="INFO"
            name="com.three.recipingadsservicebe.log.logger.AdLogger"
            additivity="false">
        <springProfile name="local,default">
            <appender-ref ref="CONSOLE" />
        </springProfile>
        <springProfile name="dev,prod,test">
            <appender-ref ref="JSON_STDOUT" />
        </springProfile>
    </logger>

    <!-- ===== 개발 환경 디버깅 설정 ===== -->
    <springProfile name="local">
        <logger name="com.three.recipingadsservicebe.ad" level="DEBUG" additivity="true"/>
        <logger name="com.three.recipingadsservicebe.targeting" level="DEBUG" additivity="true"/>
        <logger name="com.three.recipingadsservicebe.abtest" level="DEBUG" additivity="true"/>
        <logger name="com.three.recipingadsservicebe.log" level="DEBUG" additivity="true"/>
    </springProfile>

    <!-- ===== 외부 라이브러리 로그 레벨 조정 ===== -->
    <logger name="org.springframework.security" level="WARN"/>
    <logger name="org.apache.http" level="WARN"/>
    <logger name="com.fasterxml.jackson" level="WARN"/>
    <logger name="net.logstash.logback" level="WARN"/>
    <logger name="org.springframework.web.servlet.DispatcherServlet" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="com.zaxxer.hikari" level="WARN"/>

</configuration>